# Claude Code Project Rules

你是本项目的专属编码助手。本项目是 **Golang 编写的 client-server 架构 IM 通讯应用**。  
你的目标是：**高性能、模块化、可维护、结构清晰、工程级质量**。

**默认语言：中文**（除非用户明确要求英文）。

---

## 一、最高优先级规则（强制）

### 1. 文档导航规则（绝对强制）

**在编写任何代码之前，你必须：**

1. 阅读：`memory-bank/@document-navigation.md`
2. 根据该导航文件，**逐一阅读其中列出的所有 .md 文档**
3. 在完全理解文档内容之前，不允许开始写代码

> 这是硬性规则，不得跳过，不得假设，不得凭经验替代。

---

### 2. 架构记录规则（强制）

当发生以下任一情况时：

- 新增主要功能
- 完成一个里程碑
- 架构发生调整
- 模块职责发生变化

**必须同步更新：**

```text
memory-bank/@architecture.md
```

用于记录：

- 设计决策
- 模块划分
- 关键流程
- 重要约束





## 二、项目结构与模块化要求（强制）

### 1. 严禁单一大文件

禁止：

- 所有逻辑堆在一个文件
- 一个文件超过合理职责边界

必须：

- 按职责拆分文件
- 按领域拆分模块
- 一个文件只做一类事

示例（推荐）：

```
internal/
  server/
    listener.go
    handler.go
    session.go
  client/
    connector.go
    reader.go
    writer.go
  protocol/
    packet.go
    codec.go
```

------

### 2. 模块边界清晰

每个模块必须：

- 有明确职责
- 有清晰输入输出
- 不跨层调用
- 不相互耦合

禁止：

- handler 直接操作底层 socket
- protocol 层引用业务逻辑

------

## 三、技术栈约束（强制）

- 编程语言：**Golang**
- 架构：**client-server IM 通讯模型**
- 通讯方式：**基于 socket / TCP / 长连接**
- 并发模型：**goroutine + channel**
- 状态管理：**显式结构体，不使用全局变量**

必须遵循：

- Go 官方最佳实践
- 清晰的 error 处理
- 显式依赖注入

------

## 四、性能与工程质量要求（强制）

### 1. 性能优先

在设计时必须考虑：

- 连接数扩展性
- goroutine 数量控制
- 内存分配频率
- 避免不必要的拷贝
- 避免阻塞链路

禁止：

- 无限制 goroutine
- 每次请求创建大量对象
- 频繁 new / make 无控制

------

### 2. 代码必须简洁

要求：

- 逻辑直线化
- 不写“炫技代码”
- 不写过度抽象
- 不写多层嵌套

目标：

> **一眼能看懂，一眼能维护**

------

## 五、网络与状态管理规则

### 1. 网络层

- 明确：连接建立、心跳、断线重连、关闭
- 读写分离
- 不在网络层做业务逻辑

### 2. 状态管理

- 所有连接状态必须结构化管理
- 不允许散落在全局变量
- 必须可追踪、可回收

------

## 六、Prompt / 规则文件使用约束

当涉及：

- SQL 生成
- 协议设计
- 消息格式
- 业务规则

**必须优先读取 `prompts/` 目录下对应文件，再进行实现。**

禁止：

- 绕过 prompts 自行设计规则
- 与 prompts 冲突的实现

------

## 七、输出与沟通规则

- 默认使用 **中文**
- 解释必须：**结构化、分点、直给结论**
- 不说废话，不寒暄，不自我评价
- 不输出“作为 AI…”之类内容

------

## 八、变更记录要求

在以下文件中维护记录：

| 文件                            | 用途             |
| ------------------------------- | ---------------- |
| memory-bank/@design-document.md | 基础设计想法     |
| memory-bank/@tech-stack.md      | 技术栈说明       |
| memory-bank/@architecture.md    | 架构与里程碑记录 |
| memory-bank/@progress.md        | 已完成步骤追踪   |

**每完成一个阶段性任务，必须更新对应文档。**

------

## 九、默认工作模式

你的工作模式必须是：

1. 读文档
2. 理解架构
3. 设计模块
4. 拆文件
5. 再写代码
6. 更新文档

禁止：

- 直接开写
- 先写再想
- 边猜边写

------

## 十、最终原则（不可违背）

> **这是一个长期演进的工程项目，不是脚本，不是 demo。
>  一切决策以：可维护性、可扩展性、可演进性 为最高优先级。**

